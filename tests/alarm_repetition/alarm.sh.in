#!/bin/bash

#The health directory to put the alarms
HEALTHDIR="@configdir_POST@/health.d/"

#output directory
OUTDIR="alarms/"

#url to do download
MURL="http://localhost:19999/api/v1/alarms?active"

#error messages
RED='\033[0;31m'
GREEN='\033[0;32m'
NOCOLOR='\033[0m'

MYCDIR="$(pwd)"
CONFFILE="$MYCDIR/netdata.conf"

change_alarm_file() {
  if [ -f "$1" ]; then
    rm "$1"
  fi

  #copy keeping the permissions
  cp -a "$2" "$3"
}

netdata_test_download() {

}

get_the_logs() {
  curl -v -k --create-dirs -o "$OUTDIR/$1.out" "$MURL" 2> "$OUTDIR/$1.err"
  netdata_test_download "$OUTDIR/$1.err" "$OUTDIR/$1.out" "$2"
}

process_data() {
  netdata -c "$CONFFILE"
  echo -e "${NOCOLOR}Sleeping during 300 seconds to create alarm entries"
  sleep 300
  get_the_logs "$1" "$2"
  killall netdata
}

mkdir "$OUTDIR"
CREATEDIR="$?"
if [ "$CREATEDIR" -ne "0" ]; then
  echo  -e "${RED}Cannot create the output directory, it already exists. The test will overwrite previous results."
fi

change_alarm_file "./0" "ram_without_repetition.conf" "$HEALTHDIR/ram.conf"
cp -a netdata.conf_without_repetition netdata.conf
process_data "ram_without" "0"

change_alarm_file "ram_without_repetition.conf" "ram_with_repetition.conf" "$HEALTHDIR/ram.conf"
cp -a netdata.conf_with_repetition netdata.conf
process_data "ram_with" "0"

echo  -e "${GREEN} all the tests were sucessful"
